<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor General - SatyaLedger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            background: white;
            border-radius: 10px;
            padding: 15px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .navbar-brand img {
            height: 36px;
            vertical-align: middle;
            margin-right: 12px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .user-role {
            font-size: 0.85em;
            color: #666;
        }

        .btn-logout {
            padding: 8px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .filter-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #667eea;
            color: white;
        }

        .filter-tab:hover {
            background: #764ba2;
            color: white;
        }

        .btn-receipt {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .btn-receipt:hover {
            background: #218838;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .ministry-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .transaction-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .tx-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .tx-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .tx-card.voted {
            background: #f0f8f0;
            border-color: #28a745;
        }

        .tx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tx-id {
            font-family: monospace;
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
        }

        .tx-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .btn-approve {
            padding: 10px 25px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-approve:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-approve:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-voted {
            background: #d1ecf1;
            color: #0c5460;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .tx-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" alt="Government of India">
            SatyaLedger
        </div>
        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">Auditor General</div>
                <div class="user-role">Transaction Auditor</div>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üîç Auditor General Dashboard</h1>
            <p>Review and approve pending transactions</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="pendingCount">0</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="approvedByMe">0</div>
                <div class="stat-label">Approved by Me</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalApproved">0</div>
                <div class="stat-label">Fully Approved</div>
            </div>
        </div>

        <div class="card">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterTransactions('pending')">
                    ‚è≥ Pending (<span id="pendingFilterCount">0</span>)
                </button>
                <button class="filter-tab" onclick="filterTransactions('approved')">
                    ‚úÖ Approved (<span id="approvedFilterCount">0</span>)
                </button>
                <button class="filter-tab" onclick="filterTransactions('all')">
                    üìã All Transactions (<span id="allFilterCount">0</span>)
                </button>
            </div>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Approval Process:</strong><br>
                ‚Ä¢ Each transaction requires unanimous approval from ALL 3 eligible ministries<br>
                ‚Ä¢ Transaction creator is excluded from voting<br>
                ‚Ä¢ Review transaction details carefully before approving<br>
                ‚Ä¢ Once approved, you cannot revoke your vote
            </div>

            <div style="background: #ffe8e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>üèõÔ∏è Approving as: <span class="ministry-badge">Auditor General</span></strong><br>
                <small>Address: <span id="ministryAddress" style="font-family: monospace;">0x76F52BE2B49cc3466897865fa488dCa8B5cBa33b</span></small>
            </div>

            <div class="transaction-list" id="transactionList">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <h3>No Pending Transactions</h3>
                    <p>All transactions have been reviewed</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        const AUDITOR_GENERAL = "0x76F52BE2B49cc3466897865fa488dCa8B5cBa33b";
        const CONTRACT_ADDRESS = "0xA33e479090a4858951ceCD3d62071B15E0a29291";
        
        let web3;
        let contract;

        // Contract ABI
        const contractABI = [
            {
                "inputs": [{"internalType": "bytes32", "name": "_txId", "type": "bytes32"}],
                "name": "approveTransaction",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "bytes32", "name": "_txId", "type": "bytes32"}],
                "name": "getTransaction",
                "outputs": [
                    {"internalType": "string", "name": "beneficiaryId", "type": "string"},
                    {"internalType": "string", "name": "schemeName", "type": "string"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"},
                    {"internalType": "string", "name": "receiptHash", "type": "string"},
                    {"internalType": "address", "name": "createdBy", "type": "address"},
                    {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                    {"internalType": "string", "name": "status", "type": "string"},
                    {"internalType": "uint8", "name": "approvals", "type": "uint8"},
                    {"internalType": "bool", "name": "finalized", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "bytes32", "name": "_txId", "type": "bytes32"},
                    {"internalType": "address", "name": "_ministry", "type": "address"}
                ],
                "name": "hasVoted",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Check authentication
        function checkAuth() {
            if (sessionStorage.getItem('isLoggedIn') !== 'true' || sessionStorage.getItem('userType') !== 'auditor') {
                window.location.href = 'login.html';
                return false;
            }
            document.getElementById('userName').textContent = sessionStorage.getItem('userName');
            return true;
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // Initialize Web3
        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    contract = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);
                    loadTransactions();
                } catch (error) {
                    console.error('Failed to connect to MetaMask:', error);
                }
            } else {
                alert('‚ö†Ô∏è MetaMask not detected. Please install MetaMask.');
            }
        }

        async function loadTransactions(filter = 'pending') {
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const listDiv = document.getElementById('transactionList');

            if (transactions.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No Transactions</h3>
                        <p>No transactions available</p>
                    </div>
                `;
                updateFilterCounts(0, 0, 0);
                return;
            }

            let pendingCount = 0, approvedCount = 0, approvedByMe = 0, totalApproved = 0;

            // Get approval status for each transaction
            const txWithStatus = await Promise.all(transactions.map(async tx => {
                const voted = tx.voters && tx.voters.includes('auditor');
                const isApproved = tx.approvals >= 3;
                
                if (voted) approvedByMe++;
                if (isApproved) {
                    totalApproved++;
                    approvedCount++;
                } else if (!voted) {
                    pendingCount++;
                }

                return { ...tx, voted, isApproved };
            }));

            // Filter transactions
            let filteredTx = txWithStatus;
            if (filter === 'pending') {
                filteredTx = txWithStatus.filter(tx => !tx.isApproved && !tx.voted);
            } else if (filter === 'approved') {
                filteredTx = txWithStatus.filter(tx => tx.isApproved);
            }

            // Update filter counts
            updateFilterCounts(pendingCount, approvedCount, transactions.length);

            if (filteredTx.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No ${filter.charAt(0).toUpperCase() + filter.slice(1)} Transactions</h3>
                        <p>Change the filter to view other transactions</p>
                    </div>
                `;
            } else {
                listDiv.innerHTML = filteredTx.map(tx => {
                    const progress = (tx.approvals / 3) * 100;
                    const receiptButton = tx.isApproved ? 
                        `<button class="btn-receipt" onclick="viewReceipt('${tx.txId}')">üìÑ View Receipt</button>` : '';
                    
                    return `
                        <div class="tx-card ${tx.voted ? 'voted' : ''}">
                            <div class="tx-header">
                                <div>
                                    <strong style="font-size: 1.1em;">${tx.schemeName}</strong><br>
                                    <span class="tx-id">TX ID: ${tx.txId}</span>
                                </div>
                                <span class="status-badge ${tx.isApproved ? 'status-approved' : (tx.voted ? 'status-voted' : 'status-pending')}">
                                    ${tx.isApproved ? '‚úÖ Fully Approved' : (tx.voted ? '‚úì You Approved' : '‚è≥ Pending')}
                                </span>
                            </div>
                        </div>

                        <div class="tx-details">
                            <div class="detail-item">
                                <span class="detail-label">Beneficiary ID</span>
                                <span class="detail-value">${tx.beneficiaryId}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Amount</span>
                                <span class="detail-value">‚Çπ${tx.amount.toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Created</span>
                                <span class="detail-value">${new Date(tx.timestamp).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Receipt Hash</span>
                                <span class="detail-value" style="font-family: monospace; font-size: 0.85em;">${tx.receiptHash.substring(0, 20)}...</span>
                            </div>
                        </div>

                        <div>
                            <strong>Approval Progress: ${tx.approvals}/3</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9em; color: #666;">
                                ${tx.voted ? '‚úì You have approved this transaction' : 'Awaiting your approval'}
                            </span>
                            <div>
                                <button class="btn-approve" 
                                        onclick="approveTransaction('${tx.txId}')" 
                                        ${tx.voted || tx.isApproved ? 'disabled' : ''}>
                                    ${tx.voted ? '‚úì Approved' : 'Approve Transaction'}
                                </button>
                                ${receiptButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            }

            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('approvedByMe').textContent = approvedByMe;
            document.getElementById('totalApproved').textContent = totalApproved;
        }

        function updateFilterCounts(pending, approved, total) {
            document.getElementById('pendingFilterCount').textContent = pending;
            document.getElementById('approvedFilterCount').textContent = approved;
            document.getElementById('allFilterCount').textContent = total;
        }

        let currentFilter = 'pending';
        function filterTransactions(filter) {
            currentFilter = filter;
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            loadTransactions(filter);
        }

        function viewReceipt(txId) {
            window.open(`receipt.html?txId=${txId}`, '_blank');
        }

        async function approveTransaction(txId) {
            if (!confirm('Are you sure you want to approve this transaction?')) {
                return;
            }

            try {
                // Send approval to blockchain
                await contract.methods.approveTransaction(txId).send({ 
                    from: AUDITOR_GENERAL, 
                    gas: 300000 
                });

                // Update local storage
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                const txIndex = transactions.findIndex(t => t.txId === txId);
                
                if (txIndex !== -1) {
                    transactions[txIndex].approvals = (transactions[txIndex].approvals || 0) + 1;
                    transactions[txIndex].voters = transactions[txIndex].voters || [];
                    transactions[txIndex].voters.push('auditor');
                    
                    if (transactions[txIndex].approvals >= 3) {
                        transactions[txIndex].status = 'Approved';
                    }
                    
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                }

                alert('‚úÖ Transaction approved successfully!');
                loadTransactions(currentFilter);

            } catch (error) {
                alert('‚ùå Approval failed: ' + error.message);
            }
        }

        // Initialize
        if (checkAuth()) {
            window.addEventListener('load', initWeb3);
        }
    </script>
</body>
</html>
